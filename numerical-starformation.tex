\subsection{Star formation and feedback}
\label{sec.ov.star}

%\red{By the time this paper is submitted my (BWO's) paper on the star formation
%and feedback algorithms, and the various parameters contained therein, should be
%at least written and submitted as well.  Point to this, and maybe include a couple
%interesting plots (perhaps in an appendix?).}
%GB: can we really point to that paper?

While the physics discussed previously is all crucial to the study of
cosmological structure formation, most cosmological observations are of
stars and related phenomena.  Additionally, stars eject energy and metal-
enriched gas throughout their lives, drastically modifying their own 
environment.  The formation of galaxies and clusters cannot be completely
modeled without including the feedback of energy and metals.  In particular,
it is thought that feedback is crucial for suppressing the large numbers of
dwarf-like galaxies that CDM theories predict 
\citep{1991ApJ...381...14L,1991ApJ...379...52W}.  An early
burst of star formation could remove a large fraction of cold gas from such systems
\citep{1978MNRAS.183..341W,1991ApJ...367...45C}.  Also, the unexpectedly 
low luminosities of small clusters and
groups (relative to the richest clusters) is commonly explained through feedback
\citep{1991ApJ...383..104K}.  Energy ejected during the formation of the cluster ellipticals 
lowers the central density and hence the X-ray luminosity of such clusters 
 \citep{1997ApJ...484L..21C}.  Therefore, the inclusion of star formation and the 
feedback of energy and metals into the intergalactic medium in a cosmological
code is crucial for many reasons.  

We have extended the \enzo\ code to include multiple models for star formation
and feedback.  It is difficult to directly simulate the formation of individual
stars in the context of simulations of galaxy formation and evolution due
to the immense computational cost.  Therefore, we adopt a parametric method which attempts
to model star forming regions in a plausible but heuristic way.  
%One model is based on Kravtsov's method  \citep{2003ApJ...590L...1K}, and the other is 
Our model is based on the method of  \citet{CO1992}, which 
has been modified for use in an AMR code.  The basic
ideas behind the methods are straightforward and observationally motivated.
Similar (though somewhat more advanced) methods have been employed for the 
smoothed particle hydrodynamics
(SPH) method, most recently by Springel \& Hernquist 
\citep{sh03a,sh03b,hs03}. This 
method assumes a multiphase IGM and has been shown to accurately reproduce the cosmic star
formation rate, and will be implemented into \enzo\ in the near future.

%In the following sections we will detail both the Kravtsov and Cen \& Ostriker star formation methods separately.  
Tests of the star formation and
feedback algorithms will not be shown, since this work is currently in
progress (and an extension of the AMR/SPH code comparison described in
\citet{2005ApJS..160....1O}).
%
%\subsubsection{The Kravtsov star formation and feedback algorithm}

% GB: Is this going to be in the code????
% GB: I assume not, so I am commenting it out.  Text to be used in another paper?

%Kravtsov's method of star formation is designed to reproduce
%the global Schmidt law of star 
%formation~\citep{2003ApJ...590L...1K,1959ApJ...129..243S}.
%This algorithm is deliberately minimal, and is explicitly geared
%towards modeling star formation in a phenomenological way on kiloparsec
%scales.  Stars are assume to form with a characteristic gas timescale 
%$\tau_*$ such that $\dot{\rho}_* = \rho_{gas}/\tau_*$ where $\rho_{gas}$ 
%and $\rho_*$ are the baryon gas and stellar densities, respectively.  
%This ``constant efficiency'' model on the scale of star formation 
%regions is well motivated observationally \citep{1996AJ....112.1903Y,2002ApJ...569..157W}.  
%Star formation is only allowed to take place in very dense regions
%with $\rho_{gas} \geq \rho_{SF}$, where $\rho_{SF}$ is a constant
%proper density threshold above which star formation is allowed to
%occur.  No other criteria are imposed.  Kravtsov's typical choices
%for $\tau_*$ and $\rho_{SF}$ are $\tau_* = 4$ Gyr and $\rho_{SF} =
%1.64~$M$_\odot$~pc$^{-3}$~$(n_H \sim 50$~cm$^{-3})$.  The adopted timescale
%is derived from the observationally-determined normalization of the
%Schmidt law, and the density threshold is determined by observations
%of star forming regions on $\sim 100$ pc scales.  Note that the density
%threshold is in proper, not comoving, units.

%Algorithmically, the star formation events in Kravtsov's code
%are assumed to occur once every global time step 
%$\Delta t_0 \leq 10^7$.  In cells where star formation is
%determined to occur (i.e. $\rho_{gas} \geq \rho_{SF}$) a
%collisionless ``star particle'' is assumed to form, with a 
%mass $m_* = \dot{\rho}_* V_{cell} \Delta t_0$, where
%$\dot{\rho}_*$ is described above and $V_{cell}$ is the 
%volume of the mesh cell.  These star particles are
%formed instantaneously, with all $m_*$ of gas being
%taken out of the cell and immediately deposited into the
%star particle.  This particle is then given the velocity
%of the gas in the cell, and thereafter treated as a 
%collisionless particle.  The \enzo\ implementation
%of this algorithm is similar, except that instead of 
%forming stars only at the root grid time step, we allow 
%stars to form at the time step of the highest level of
%resolution at any particular point in space.  As can be seen
%from the equation for $m_*$ above, this can result in very 
%small stellar masses.  To avoid memory and processor time
%issues related to having very large numbers of star particles
%we impose a threshold mass $M_{*,min}$ such that a star
%particle only forms if $m_* \geq M_{*,min}$.  An
%appropriate choice of $M_{*,min}$ does not significantly 
%change the star overall star formation history of a 
%simulation, though it may delay the onset of star formation 
%in a given cell relative to a simulation without a particle mass
%threshold.

%Each ``star particle'' is assumed to represent an ensemble
%of stars and is treated as a single-age stellar population.
%Kravtsov assumes that the IMF is described by a
%Miller \& Scalo functional form with stellar masses between
%$0.1$ and $100~M_\odot$ \citep{1979ApJS...41..513M}.  All stars in this
%IMF with $M_* > 8~M_\odot$ deposit $2 \times 10^{51}$ ergs of
%thermal energy and a mass $f_z M_*$ of metals into the
%cell in which they form without delay, with
%$f_z \equiv min(0.2, 0.01~M_*-0.06)$ (i.e. instantaneous
%deposition of metals).  The definition of $f_z$ is a rough
%approximation of the results of 
%\citet{1995ApJS..101..181W}.

%Kravtsov reports that simulations with this algorithm
%reliably reproduce the star formation rate-gas surface
%density relation of the Schmidt law, and are not particularly
%sensitive to numerical parameters \citep{2003ApJ...590L...1K}.
%He also notes that this is surprisingly insensitive to
%the presence or absence of feedback and details of the cooling
%and heating properties of the gas, which suggests that the
%global star formation rate is determined by gravitationally-
%driven supersonic turbulence (on large scales)
%rather than stellar feedback or thermal instabilities on small 
%scales.

%\subsubsection{The Cen \& Ostriker star formation algorithm}

The Cen \& Ostriker method is a heuristic model of star formation
on galactic scales.  This method, first described by
\citet{1992ApJ...399L.113C}, is similar in some ways to the Kravtsov algorithm
but has more complex criteria for determining where stars should
be formed.  In this method, cells that form stars must have a 
baryon overdensity higher than some threshold 
$\rho_b/\bar{\rho}_b \geq \eta$ 
where $\rho_b$ is the baryon density in that cell, 
$\bar{\rho_b}$ is the mean baryon density in the simulation,
and $\eta$ is the user-defined overdensity threshold.
Additionally, the gas in the cells must be contracting, 
cooling rapidly, and gravitationally unstable, e.g.:

\begin{equation}
\nabla \cdot \vec{v}_b < 0,
\label{cencont}
\end{equation}

\begin{equation}
t_{cool} < t_{dyn} \equiv \sqrt{3 \pi / 32G \rho_{tot}},
\end{equation}

\begin{equation}
m_{b} > m_{J} \equiv G^{-3/2} \rho_{b}^{-1/2}C^{3}
\left[ 1 + \frac{\delta\rho_{d}}{\delta\rho_{b}} \right]^{-3/2}
\end{equation}

where $\vec{v}$ is the velocity of the gas in the cell, $\rho_{b}$ and 
$\rho_{d}$ are the cell's baryon and dark matter density, respectively,
$\rho_{total} = \rho_{b} + \rho_{d}$, $m_{b}$ and $m_{j}$ are the 
baryonic mass in the cell and jeans mass of the cell, and C is the 
isothermal sound speed in the cell.  
If all of these criteria are met, 
the mass of a star particle is calculated as \(m_{*} = m_{b} 
\frac{ \Delta t}{ t_{dyn} } f_{*eff} \), 
where $f_{*eff}$ is the star formation efficiency parameter.

If $m_{*}$ is greater than a minimum star mass $m_{*min}$, a particle 
is created and given several attributes:  Mass, a unique index number, 
the time of formation $t_{form}$, the local dynamical free-fall time 
$t_{dyn}$ and the metallicity fraction of the baryon gas in the cell 
$f_{Zb}$.  There is a user-defined minimum dynamical time
$T_{dyn,min}$ which is observationally motivated and affects the
feedback rates (see below).
The particle is placed in the center of the cell and given 
the same peculiar velocity as the gas in the cell, and is then treated 
in the same manner as the dark matter particles.  An 
amount of baryon gas corresponding to the new particle's mass is 
removed from the cell.  

In addition, we have added a stochastic star formation algorithm that keeps 
track of all of the sub-mass threshold stars that should have been created 
and when the total mass of uncreated stars is greater than the minimum mass, 
a star particle is created.

The feedback of energy and metals into the baryon gas is similar to
the Kravtsov feedback, with some important differences.  The star formation 
algorithm creates each star particle instantaneously.  However, feedback
should take place over a significant timescale, as all of the stars contained
within the ``star particle'' would form over a long period of time.  Therefore,
we assume that for the purposes of feedback that the mass of stars formed
at a time $t$ with finite timestep $\Delta t$ is:

\begin{eqnarray}  
\Delta m_{sf} =  m_{*} \left[ \left(1 + \frac{t-t_{form}}{t_{dyn}}  \right)
%\nonumber \times \\ % uncomment for 2-column
		   \exp{\left( \frac{-(t-t_{form})}{t_{dyn}} \right) }
%                    \nonumber \\ 
	       - \left( 1 + \frac{t+ \Delta t-t_{form}}{t_{dyn}} \right) 
%	       \nonumber \\ 
                    \exp{ \left( \frac{-(t+\Delta t-t_{form})}{t_{dyn}} \right)  }
                   \right]
\end{eqnarray}

which can be represented more clearly in integral form:

\begin{eqnarray}
\int_{t}^{t+Dt} \frac{dM}{dt} dt = \int_{t}^{t+Dt} m_{*} 
\frac{dt}{t_{tyn}} \left( \frac{t-t_{form}}{t_{dyn}} \right) 
%\nonumber \times \\ 
\exp{ \left( - ~ \frac{t-t_{form}}{t_{dyn}} \right) }
\end{eqnarray}

During this timestep, we assume that the star particle feeds back
metal-enriched gas and thermal energy from supernovae and from stellar winds.
Since massive stars have very short lifetimes, we assume that there is an
immediate feedback of some fraction $f_{SN}$ of the rest energy from the
stars created that timestep into the baryon gas, such that 
$E_{add} = f_{SN} \Delta m_{sf} c^2$, where c is the speed of light.
In addition, a fraction $f_{Z*}$ of the metal from the star particle
is fed back into the baryon gas, which takes into account the effects
of metal recycling.  Finally, a fraction of the mass $f_{m*}$ from all
stars (rather than just supernovae) is fed back into the gas along with
momentum in order to simulate the mass ejection from non-exploding stars
via stellar winds.

There are six user-defined parameters in this algorithm:  three deal with the
star formation ($\eta$, $m_{*min}$ and $T_{dyn,min}$), and three 
deal with feedback ($f_{SN}$, $f_{Z*}$ and $f_{m*}$).  Some of these
parameters are completely free, while others can be guided by observation
or theory.  For example, the supernova feedback parameter, $f_{SN}$, can be 
constrained assuming that, for every $200 M_\odot$ of stars created, one
supernova occurs, and this event feeds back approximately $10^{51}$ ergs of
thermal energy, giving:

\begin{equation}
f_{SN} = \frac{10^{51} ergs}{200~M_\odot c^2} \simeq 3 \times 10^{-6}
\end{equation}

The metal yield $f_{Z*}$, defined as the mass in metals produced per unit
mass of stars created, can be constrained by a theoretical model of
 \citet{1995ApJS..101..181W}.  This model suggests that $f_{Z*} = 0.02$
is an appropriate number.  The minimum dynamical time is set to be $T_{dyn,min} = 10^7$
~years to agree with timescales seen in nearby OB associations.

The other parameters, such as the overdensity threshold $\eta$, minimum star
 mass $m_{*min}$, and mass ejection fraction $f_{m*}$ are not well constrained 
either theoretically or observationally.  Indeed, $m_{*min}$ is a purely
numerical parameter designed to keep the code from producing too many star 
particles, and thus has no observational or theoretical counterpart.  These
parameters have to be set by performing parameter studies and comparing to 
observations.  Unfortunately, the range of parameter space is large, and
the results may be degenerate for some combinations of these parameters.

