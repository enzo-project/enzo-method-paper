

\section{Physical Equations and Overview of Numerical Methodology}
\label{sec.overview}

We begin this section by first writing down the complete set of
physical equations that can be solved by \enzo, and then briefly
describe the numerical algorithms that we use to solve these
equations.  This section is intended to be an overview of the
\enzo\ code's capabilities: thus, we gather all of the equations
solved into a single place and provide a brief and high-level
introduction to the numerics of the code.  Detailed descriptions of
the individual components are then provided in
Sections~\ref{sec.amr}-\ref{sec.num.analysis}. In
Table~\ref{tab:variables} we provide a convenient summary of all
variables and physical constants used throughout this manuscript.

\mqk{Move this table to the Appendix?}
\input{table_of_variables_and_constants}

% ====================================================

\subsection{Physical Equations}
\label{sec.equations}

% ----------------------------------------------------------------------------------------

%\subsubsection{Magnetohydrodynamics and Gravity}

The Eulerian equations of ideal magnetohydrodynamics including
gravity, in a coordinate systems comoving with the cosmological
expansion, are given by:

\begin{eqnarray} 
  \frac{\partial \rho}{\partial t} 
  + \frac{1}{a} \nabla \cdot (\rho \vecv) & = & 0
  \label{eq:mass} \\
%
  \frac{\partial \rho \vecv}{\partial t}  
  + \frac{1}{a} \nabla \cdot \left(\rho \vecv \vecv + \myvec{I}p^* - 
    \frac{\vecB \vecB}{a} \right) & = &
  - \frac{\dot{a}}{a} \rho \vecv - \frac{1}{a} \rho \nabla \phi
% 
%          + \frac{1}{a} ( \vecv \cdot \nabla ) \vecv
%    & = & - \frac{\dot{a}}{a} \vecv 
%          - \frac{1}{a \rho} \nabla p
%          - \frac{1}{a \rho} (\nalba \times \vecB) \times \vecB
%          - \frac{1}{a} \nabla \phi, 
  \label{eq:momentum} \\
%
  \frac{\partial E}{\partial t} 
  + \frac{1}{a} \nabla \cdot \left[ (E + p^*) \vecv - 
    \frac{1}{a} \vecB (\vecB \cdot \vecv) \right] & = &
  - \frac{\dot{a}}{a} \left( 2E - \frac{B^2}{2a} \right) - 
  \frac{1}{a} \vecv \cdot \nabla \phi 
  - \Lambda + \Gamma + \frac{1}{a^2} \nabla \cdot \fcond
% 
%         + \frac{1}{a} \vecv \cdot \nabla E
%  & = & - \frac{\dot{a}}{a} (3 \frac{p}{\rho} + {\vecv \cdot \vecv} )
%       - \frac{1}{a \rho } \nabla \cdot (p \vecv) 
%%\nonumber   & &   %uncomment for 2-column
%        - \frac{1}{a} \vecv \cdot \nabla \phi 
%               + \Gamma - \Lambda.
  \label{eq:total_energy}  \\
%
  \frac{\partial \vecB}{\partial t} - 
  \frac{1}{a}  \nabla \times (\vecv \times \vecB) & = & 
  -\frac{\dot{a}}{2 a} \vecB \label{eq:induction}
\end{eqnarray}

%\begin{eqnarray} 
%\frac{\partial \rho}{\partial t} 
%          + \vecv \cdot \nabla \rho
%    & = & - \rho \nabla \cdot \vecv,
%        \label{eq:mass} \\
%%
%\frac{\partial \vecv }{ \partial t} 
%          + ( \vecv \cdot \nabla ) \vecv 
%    & = & - \frac{1}{\rho} \nabla p
%          - \nabla \phi,
%        \label{eq:momentum} \\
%%
% \frac{\partial E}{\partial t} + \vecv \cdot \nabla E
%    & = & - \frac{1}{\rho} \nabla \cdot (p \vecv) 
%          - \vecv \cdot \nabla \phi
%%\nonumber          \\  & &     % uncomment for 2-column
%     + \Gamma - \Lambda
%        \label{eq:total_energy}
%\end{eqnarray}
%
In these equations, $E$, $\rho$, $\vecv$, and $\vecB$ are the comoving
total fluid energy density, comoving baryonic density, peculiar velocity, and
comoving magnetic field strength, respectively.  $\myvec{I}$ is the
identity matrix, and $a$ is the cosmological expansion parameter
(which is discussed in more detail below).  The first equation
represents conservation of mass, the second, conservation of momentum,
and the third, conservation of total fluid (kinetic plus thermal)
energy.  They are respectively, the first, second and third moments of
the Boltzmann equation.  The fourth equation is the magnetic induction
equation.  Terms representing radiative cooling ($\Lambda$) and
heating ($\Gamma$) enter on the right-hand side of the energy equation
(\ref{eq:total_energy}), as well as the flux due to thermal heat
conduction ($\fcond$).

The total fluid energy density $E$ is given by:
\begin{equation}
E =  e + \frac{\rho v^2}{2}  + \frac{B^2}{2a}
        \label{eq:total_energy_def}.
\end{equation}
where $e$ is the comoving thermal energy density, and the total
isotropic pressure $p^*$ is given by
\begin{equation}
p^* = p + \frac{B^2}{2a},
\end{equation}
where $p$ is the gas pressure.  The equations are closed with the
equation of state and Poisson's equation (we work in the Newtonian
limit):
%
\begin{eqnarray}
%
  e &=& p / [(\gamma - 1) \rho ],
  \label{eq:eq_of_state} \\
%
  \nabla^2 \phi &=& 4 \pi G \rho_{\rm total}
%                   + 3 p_{total}/c^2) - \Lambda. 
  \label{eq:potential}
\end{eqnarray}
%
The equation of state is shown here for an ideal gas with a ratio of
specific heats $\gamma$.  Equation (\ref{eq:potential}) includes
contributions to the gravitational potential $\phi$ from the total
mass density $\rho_{\rm total}$, which is defined as $\rho_{\rm gas} +
\rho_{\rm dm} + \rho_{\rm stars} - \rho_{\rm average}$.  Although we
write the equations including both MHD and comoving coordinates, the
code is frequently used both in the pure hydrodynamic limit ($\vecB =
0$) and without cosmological expansion ($a = 1$, $\dot{a} = 0$).

% ----------------------------------------------------------------------------------------

%\subsubsection{Comoving Coordinates}

For completeness, we note here that we have defined several key
quantities in the comoving frame to make the previous equations more
readable.  Specifically, we define:

\begin{eqnarray}
\vecx & = & \vecr/a, \\
\vecv & = & a \hspace{0.5mm} d\vecx/dt = 
              \vecvp - \dot{a}\vecx, \\
\rho  & = & a^3 \rhop,   \\
p     & = & a^3 \pp, \\
E     & = & a^3 \left(\Ep - 
            \dot{a} \vecx \cdot \vecvp - 
            \frac{1}{2} \dot{a}^2 \vecx^2\right), \\
\phi  & = & \phip + \frac{1}{2} a \ddot{a} \vecx^2. \\
\vecB & = & a^2 \vecB^\prime,
\end{eqnarray}
where primes indicate the usual quantities defined in a fixed frame
frame, $\vecr$ is the proper distance and $\vecx$ is the comoving
distance.

%These definitions result in the following comoving equivalents to eqs. 
%(\ref{eq:mass})-(\ref{eq:potential}).
%%
%
%\begin{eqnarray} 
%\frac{\partial \rhop}{\partial t} 
%          + \frac{1}{a} \vecvp \cdot \nabla \rhop 
%    & = & - \frac{1}{a} \rhop \nabla \cdot \vecvp, 
%        \label{eq:mass_prime} \\
%%
%\frac{\partial \vecvp}{\partial t}  
%          + \frac{1}{a} ( \vecvp \cdot \nabla ) \vecvp 
%    & = & - \frac{\dot{a}}{a} \vecvp 
%          - \frac{1}{a \rhop} \nabla \pp 
%          - \frac{1}{a} \nabla \phip, 
%        \label{eq:momentum_prime} \\
%%
%\frac{\partial \Ep}{\partial t} 
%         + \frac{1}{a} \vecvp \cdot \nabla \Ep 
%   & = & - \frac{\dot{a}}{a} (3 \frac{\pp}{\rhop} + {\vecvp \cdot \vecvp} )
%         - \frac{1}{a \rhop } \nabla \cdot (p \vecvp) 
%%\nonumber   & &   %uncomment for 2-column
%         - \frac{1}{a} \vecvp \cdot \nabla \phip 
%                + \Gamma - \Lambda.
%       \label{eq:total_energy_prime} \\
%%
%\Ep  & = & \ep + \frac{1}{2} {\vecvp \cdot \vecvp},
%        \label{eq:total_energy_def_prime} \\
%%
%\ep                  & = & 
%        \pp/\left[ \left( \gamma - 1 \right) \rhop \right],
%      \label{eq:state_prime} \\ 
%{\nabla}^2 \phip    & = & 
%        \frac{4\pi G}{a} ( \rhop_{total} - \rhop_0 ).
%      \label{eq:poisson}
%\end{eqnarray}
%%
%%We use the proper peculiar baryonic velocity $\vecv_b \equiv a(t) d\vecx / dt$, proper pressure $p$, and modified gravitational potential $ \phi $ which is related to the potential in proper coordinates $\Phi$ by 
%%$$\phi \equiv \Phi + \frac{1}{2} a \ddot{a} \vecx^2. $$
%%The density, however, is comoving:
%%$$\rho_b \equiv \rho_{b,proper}a(t)^3, $$
The expansion parameter $a \equiv 1/(1 + z)$ follows the expansion of
a smooth, homogeneous background, where $z$, the redshift, is a
function only of $t$.  All derivatives are determined with respect to
the comoving position $\vecx$, which is defined simply to remove the
universal expansion from the coordinate system.

The evolution of $a(t)$ is governed by the formula for the expansion
of an isotropic, homogeneous universe:
%
\begin{eqnarray}
\frac{\ddot{a}}{a} & = & 
      - \frac{4 \pi G }{3 a^3 } (\rho_0 
      + 3p_0/c^2) 
      + \Lambda_c /3 .
      \label{eq:expansion} 
\end{eqnarray}
%
Here, $\rho_0$ is the mean comoving mass density (including both
baryonic and dark matter), $p_0$ is the comoving background pressure
contribution, and $\Lambda_c$ is the cosmological constant.
%$\gamma$ is the ratio of specific heats, and $\Lambda$ is the cosmological constant.
%We note that if $\gamma$ is not $5/3$ then $E$ in the first term on
%the right side of eq.~(ref{eq:total_energy}) must be replaced with 
%eq.~(\ref{eq:state}).
This system of equations is limited to the non-relativistic regime and
assumes that curvature effects are not important --- both assumptions
are reasonable as long as the size of the simulated region is small
compared to the radius of curvature and the Hubble length $c/H$, where
$c$ is the speed of light and $H = \dot{a}/a$ is the Hubble constant.

It is clear that the evolution equations are equivalent to the fixed
coordinate version in the limit in which $a = 1$ and $\dot{a} = 0$.
We include the cosmological terms with the understanding that \enzo\
is not restricted to cosmological applications -- while historically
the code was written with cosmological situations in mind (e.g.,
galaxy clusters), in more recent years it has been used to simulate a
much broader range of astrophysical environments.

%\subsubsection{Particles}

Any collisionless component (e.g., dark matter, stars) is modeled by
particles which are governed by Newton's equations in comoving
coordinates:
%
\begin{eqnarray}
\frac{d \vecx}{dt} 
    & = & \frac{1}{a} \vecv, 
          \label{eq:dm_position} \\
\frac{d \vecv}{dt} 
    & = & - \frac{\dot{a}}{a} \vecv
          - \frac{1}{a} \nabla \phi, 
          \label{eq:dm_velocity} 
\end{eqnarray}
%
The particles also make a contribution to the gravitational potential
through their contribution to Poisson's equation (Equation
\ref{eq:potential}).

%\subsubsection{Chemistry}

In addition, we can solve the mass conservation equations for a set of
chemical species and reactions.  For any species $i$ with comoving
number density $n_i$, these equations have the form:
\begin{equation}
  \frac{\partial n_i}{\partial t} 
  + \frac{1}{a} \nabla \cdot (n_i \vecv) = 
  k_{ij}(T) n_i n_j + \Gamma^{\rm ph}_j n_j 
  \label{eq:species_evolution}
\end{equation}
where $k_{ij}$ are the rate coefficients for the two-body reactions
and are usually functions of only the gas species (we will
specifically note the cases where we either include three-body
reactions or have density-dependent rates).  The $\Gamma^{\rm ph}_j$
are destruction/creation rates due to photoionizations and/or
photodissociations.  Currently the species we can follow include H,
H$^+$, He, He$^+$, He$^{++}$, and e$^-$, as well as additional options
that add H$^-$, H$_2$, H$_2^+$, and HD, D, and D$^+$.  We also can
track the advection of a comoving metal density that may contribute to
the radiative cooling.

%\red{
%There is some debate over whether to put in the hydro equations without cosmology, in addition
%to the equations that are already here.  Would this
%be more or less clear?  We're leaning towards saying ``when cosmology is turned off,
% $\dot{a}$ goes to zero and $a$ goes to 1, and the poisson equation changes to blah blah blah'' 
%and assuming our readers can figure it out for themselves.
%We also want to emphasize that the heating and cooling is glossed over in this section, 
%and it's discussed more thoroughly later.
%} %end red
% GB: I agree this would be shorter, and maybe it is a better idea, but I think it's nice to be able
% GB: to include both equations and at the same time make the transformation to comoving coords
% GB: very clear -- this has engendered a lot of confusion in the past and one of the goals of writing
% GB this paper is to answer peoples questions before they ask them.


% GB: I commented out the following.  It has now been incorporated into the above discussion
% GB: (see my comments anove on why I think this is a good way to do it)
%
%\enzo\ solves the equations of ideal gas dynamics
%in a coordinate system that is comoving with the expanding universe:

%\begin{equation}
%\frac{\partial \rho_b}{\partial t} + \frac{1}{a} \vecv_b \cdot \nabla \rho_b =  \label{enzoconserve}
% - \frac{1}{a} \rho_b \nabla \cdot \vecv_b 
%\end{equation}

%\begin{equation}
%\frac{\partial \vecv_b}{\partial t} + \frac{1}{a} (\vecv_b \cdot \nabla) \vecv_b = \label{enzomomentum} 
%-\frac{\dot{a}}{a} \vecv_b - \frac{1}{a \rho_b} \nabla p - \frac{1}{a} \nabla \phi
%\end{equation}

%\begin{eqnarray}
%\frac{\partial E}{\partial t} + \frac{1}{a} \vecv_b \cdot \nabla E =  
%- \frac{\dot{a}}{a} \left( 3 \frac{p}{\rho_b} + \vecv_b^2 \right)  \nonumber \\
%- \frac{1}{a \rho_b} \nabla \cdot (p \vecv_b) \nonumber \\
%- \frac{1}{a} \vecv_b \cdot \nabla \phi + \Gamma - \Lambda
%\label{enzoenergy}
%\end{eqnarray}

%Where $\rho_b$ is the comoving baryon density, $\vecv_b$ is the baryon velocity, $p$ is the pressure, 
%$\phi$ is the modified gravitational potential (in comoving coordinates, which is related to
%the potential in proper coordinates $\Phi$ by $\phi \equiv \Phi + 0.5 $a\"{a}$ \vecx^2$) and 
%$a$ is the ``expansion parameter'' which describes the expansion of a smooth, homogeneous 
%universe as a function of time.  This expansion parameter is related to the redshift:  
%$a \equiv 1/(1+z)$.  All derivatives are in comoving coordinates.  $E$ is the specific
%energy of the gas (total energy per unit mass), and
%$\Gamma$ and $\Lambda$ represent radiative heating and cooling processes as described below.
%  Equations~\ref{enzoconserve}, \ref{enzomomentum}
%and \ref{enzoenergy} represent the conservation of mass, momentum and total (e.g.,
%kinetic plus thermal) fluid energy.

%The equations above are closed with three more equations:

%\begin{equation}
%E = p / [(\gamma - 1) \rho_b] + \vecv^2/2   \label{enzoeos}
%\end{equation}

%\begin{equation}
%\nabla^2 \phi = \frac{4 \pi G}{a} (\rho_b + \rho_{dm} - \rho_0 )
%\label{enzopoisson}
%\end{equation}

%\begin{equation}
%\frac{\ddot{a}}{a} = - \frac{4 \pi G}{3 a^3} (\rho_0 + 3 p_0 / c^2) + \Lambda/3.
%\label{enzocomove}
%\end{equation}

%where $\rho_{dm}$ is the comoving dark matter density, $\rho_0$ is the comoving
%background density 
%($\rho_0 \equiv \Omega_{matter} \rho_{crit}$) and $p_0$ is the background pressure, 
%$\gamma$ is the ratio of specific heats and $\Lambda$ is the cosmological constant.
%Equations~\ref{enzoeos}, \ref{enzopoisson} and~\ref{enzocomove} are the 
%equation of state, Poisson's equation in comoving form and an equation that 
%describes the evolution of the comoving coordinates (i.e. the formula for the 
%expansion of an isotropic, homogeneous universe). 
%All particles in the simulation are governed by Newton's equations in comoving 
%coordinates:

%\begin{equation}
%\frac{d \vecx_{part}}{dt} = \frac{1}{a} \vecv_{part}
%\label{enzopartvel}
%\end{equation}

%\begin{equation}
%\frac{d \vecv_{part}}{dt} = -\frac{\dot{a}}{a} \vecv_{part} - \frac{1}{a} \nabla \phi
%\label{enzopartmom}
%\end{equation}

%Where $\vecx_{part}$ and $\vecv_{part}$ refer to the position and peculiar velocity of any
%particles in the system.  Note that the system of equations~\ref{enzoconserve}-\ref{enzopartmom} 
%is valid only in regimes where relativistic effects are not
%important ($v_b, v_{dm} \ll c$, where c is the speed of light) 
%and where cosmological curvature effects are 
%unimportant, meaning that the simulation volume is much smaller than the radius
%of curvature of the universe, as defined as $r_{hub} \equiv c/H_0$, where $c$ is the
%speed of light and $H_0$ is the Hubble constant.

%\dcc{Fixed punctuation, added 'no mhd, rhd' caveat to Zeus statements.  This has caused
%confusion in the past.}

%\subsubsection{Magnetohydrodynamics}



%\subsubsection{Radiation transport: ray-tracing}

The code can include either a homogeneous radiation background (with
possible local self-shielding corrections), or evolve an inhomogeneous
radiation field either by directly solving the radiative transfer
equation along rays or by solving a set of moment equations derived
from the radiative transfer equation.

The radiative transfer equation in comoving coordinates
\citep[e.g.,][]{Gnedin97} reads
%
\begin{equation}
  \label{eq:rteqn}
  \frac{1}{c} \; \frac{\partial I_\nu}{\partial t} + 
  \frac{\hat{n} \cdot \nabla I_\nu}{\bar{a}} -
  \frac{H}{c} \; \left( \nu \frac{\partial I_\nu}{\partial \nu} -
  3 I_\nu \right) = -\kappa_\nu I_\nu + j_\nu .
\end{equation}
%
Here $I_\nu \equiv I(\nu, \mathbf{x}, \Omega, t)$ is the radiation
specific intensity in units of energy per time $t$ per solid angle per
unit area per frequency $\nu$.  $\bar{a} = a/a_{em}$ is the ratio of
scale factors at the current time and time of emission.  The second
term represents the propagation of radiation, where the factor
$1/\bar{a}$ accounts for cosmic expansion.  The third term describes
both the cosmological redshift and dilution of radiation.  On the
right hand side, the first term considers the absorption coefficient
$\kappa_\nu \equiv \kappa_\nu(\mathbf{x},\nu,t)$, and the second term
$j_\nu \equiv j_\nu(\mathbf{x},\nu,t)$ is the emission coefficient
that includes any sources of radiation (whether point or diffuse).

%\subsubsection{Radiation transport: moment method}

As an alternative to the ray-casting strategy, we solve an equation
derived from integrating the equation of radiative transfer over
angles.  In particular, we use a flux-limited diffusion approximation
for radiative transfer, with couplings to both the gas energy and
chemical number densities. The equations solved are:
\begin{eqnarray}
  \label{eq:fld_radiation}
  \frac{\partial E_r}{\partial t} + \frac1a \nabla\cdot\left(E_r \vecv \right) &=& 
  \nabla\cdot\left(D\nabla E_r\right) -
  \frac{\dot{a}}{a} E_r - c\kappa E_r + \eta, \\
  \label{eq:fld_heating}
  \frac{\partial e_c}{\partial t} &=& -\frac{2\dot{a}}{a} e_c + \Gamma - \Lambda,
%  \label{eq:fld_chemistry}
%  \partial_t {\mathrm n}_i + 
%    \frac1a \nabla\cdot\left({\mathrm n}_i \vecv_b\right) &=& 
%    \alpha_{i,j} {\mathrm n}_e {\mathrm n}_j - {\mathrm n}_i
%    \Gamma_i^{ph}, \quad i=1,\ldots,N_s,
\end{eqnarray}
where $E_r = E_r(\vecx,t)$ is a grey radiation energy density and
$e_c$ is the internal energy correction due to photo-heating and
chemical cooling.
%and ${\mathrm n}_i$ correspond to the chemical number densities of
%HI, HII, HeI, HeII and HeIII, and ${\mathrm n}_e$ is the electron
%number density.  
Here, we define the grey radiation energy density through first
assuming a fixed frequency spectrum, i.e.  $E_{\nu}(\nu,\vecx,t) =
\tilde{E}_r(\vecx,t) \chi(\nu)$, and then defining the integrated
quantity
\begin{equation}
\label{eq:grey_radiation_energy}
   E_r(\vecx,t) \equiv \int_{\nu_0}^{\infty}
   E_{\nu}(\nu,\vecx,t)\,\mathrm d\nu \  = \ 
   \tilde{E}_r(\vecx,t) \int_{\nu_0}^{\infty} \chi(\nu)\,\mathrm d\nu.
\end{equation}
In addition, $D$ in Equation (\ref{eq:fld_radiation}) is the Larsen
square-root flux-limiter \citep[see][]{Morel2000}; $\kappa$ is the
total opacity; $\eta$ is the field of radiation sources; $\Gamma$
provides the radiation induced photo-heating, and $\Lambda$ the
chemical cooling.
%, $\alpha_{i,j}$ are the reaction rate coefficients defining
%the interactions between species ${\mathrm n}_i$ and ${\mathrm n}_j$,
%and $\Gamma_i^{ph}$ are the radiation induced photo-ionization rates. 

%\subsubsection{Thermal conduction}

Enzo implements the equations of isotropic heat conduction in a manner
similar to that of \citet{2007ApJ...664..135P}, where we model the
flux of isotropic heat transport,
%
\begin{equation}
\fcond = -\kappa_{sp} \nabla T.
\end{equation}
%
Here $\kappa_{sp}$ is the Spitzer conduction coefficient
\citep{1962pfig.book.....S} and T is the baryon temperature (with
fluids explicitly assumed to be single-temperature).  Saturation of
the heat flux in high-temperature, low-density regimes (such as the
intracluster medium in galaxy clusters) is taken into account.
Thermal conduction in a plasma can be strongly affected by the
presence of magnetic field lines, which may strongly suppress heat
flow perpendicular to the magnetic field.  In that case, we allow for
heat transport only along the magnetic field lines in simulations that
include this physics, as follows:

\begin{equation}
\fcond= -\kappa_{sp} \hat{\textbf{b}} (\hat{\textbf{b}} \cdot \nabla T)
\end{equation}

Where $\hat{\textbf{b}}$ is the unit vector denoting the direction of
the magnetic field.  In both the isotropic and anisotropic limits, we
assume that conductivity can be suppressed relative to the ideal
Spitzer conductivity, and express this as a multiplicative constant.

% ====================================================

\subsection{Overview of Numerical Methods}
\label{sec.method_overview}

In this section, we briefly describe the numerical methods which are
used to solve the equations outlined in Section~\ref{sec.equations}.
We proceed through the numerical methods in the same order as will be
used in Sections~\ref{sec.amr} through~\ref{sec.num.analysis} so that
there is a one-to-one correspondence between each of the following
overviews and the complete description provided in the later sections.
The goal in this section is to introduce the reader to the basic
principles of the methods without drowning in detail.

\subsubsection{Structured Adaptive Mesh Refinement}

The primary purpose of the \enzo\ code is its Adaptive Mesh Refinement
(AMR) capability, which allows it to reach extremely large dynamical
ranges with limited computational resources, opening doors previously
closed by finite memory and computational time. Unlike moving mesh
methods \citep{1995ApJS..100..269P,1995ApJS...97..231G} or methods
that subdivide individual cells \citep{Adjerid}, Berger \& Collela's
AMR (also referred to as \emph{structured} AMR) utilizes an adaptive
hierarchy of grid patches at varying levels of resolution.  Each
rectangular grid patch (referred to as a ``grid'') covers some region
of space in its \emph{parent grid} which requires higher resolution,
and can itself become the parent grid to an even more highly resolved
\emph{child grid}.

The grid hierarchy begins with the root grid, which covers the entire
domain of interest with a coarse, uniform, Cartesian grid. Then, as
the solution evolves and interesting regions form, finer meshes are
placed within these coarse regions.
% (we use the notation `below' to refer to
% finer grids and `above' for coarser grids). 
We restrict the ratio between cell sizes to be an integer, typically 2
or 4, and refer to a level as all grids with the same cell size.  In
order to keep things as simple as possible, the edges of subgrids must
coincide with the cell edge of its immediate parent (coarser)
grid. Additionally, the hierarchy can be initialized with one or more
static grids if a higher initial resolution is required.

Given the hierarchy at some time $t$, we advance the solution in the
manner of a W-cycle in a multigrid solver.  First, we determine the
maximum time step allowed for the coarsest grid based on a variety of
accuracy and stability criteria and advance the grid by that time
interval, $\Delta t_0$.  We then move down to the next level and
advance all the grids on that level by a timestep $\Delta t_1$
($\Delta t_1 \leq \Delta t_0$), which is the minimum of all the
allowed timesteps for those grids.  If there are more levels, we
repeat this procedure until the bottom level of the hierarchy has been
reached.  Once there, we continue advancing the grids on the lowest
level until they have ``caught up'' to the coarser parent grids
(i.e. $\sum \Delta t_l = \Delta t_{l-1}$).  This procedure repeats
itself until all grids have been advanced by a total time of $\Delta
t_0$ (see Figure~\ref{fig:wcycle} for a schematic).


\begin{figure}
\begin{center}
%\includegraphics[width=0.6\textwidth]{figures/wcycle.eps}
\includegraphics[width=0.6\textwidth]{figures/timestepping.eps}
\end{center}
\caption{\emph{Left:} Example of the timesteps on a 2-level AMR
  hierarchy.  Enzo does not restrict the timesteps on the finer levels
  to be a factor of $1/2^n$ smaller.  \emph{Right:} The order in which
  the AMR grids are evaluated on each level.\vspace{1ex}}
\label{fig:wcycle}
\end{figure}

Since interesting regions on the grid may move, the hierarchy must
adapt itself.  We do this whenever a level has caught up to the
coarser parent level and consists of entirely rebuilding the grids on
that level and at finer resolutions.  This is done by applying the
grid refinement criteria to the grids on that level, flagging zones
that require extra grids.  These criteria depend on the physical
problem being simulated -- see Section~\ref{sec:refinement_criteria}
for more details.  Once a grid has a set of flagged cells, we run a
machine-vision based algorithm \citep{Berger91} to find edges and
determine a good placement of subgrids.
%  These subgrids must not overlap one another, must cover all flagged
% cells and their neighbouring cells, and be above a preset efficiency
% threshold, where the efficiency of a cell is defined as the ratio of
% flagged cells to total cells. 
Once these new subgrids have been identified, the solution from the
next coarser grid is interpolated in order to initialize the values on
the new grids.  Finally, any overlap between these new subgrids and
the old ones is identified, and the solution within the regions of
overlap is copied to the new subgrids.  The entire procedure just
outlined is then repeated on the new grids and in this way the entire
hierarchy (from the original level examined and continuing on to finer
levels) is rebuilt.

\subsubsection{Godunov PPM method (HD only)}

Four different (magneto)-hydrodynamic methods are implemented in
\enzo: (i) the hydrodynamic-only piecewise parabolic method (PPM)
developed by~\citet{1984JCoPh..54..174C} and extended to cosmology
by~\citet{1995CoPhC..89..149B}; (ii) the MUSCL-like Godunov scheme
\citep{MUSCL} with or without magnetic fields and Dedner-based
divergence cleaning, described in more detail in
\citet{WangAbelZhang08} and \citet{WangAbel09}; (iii) a constrained
transport staggered MHD scheme \citep{Collins10}, and (iv) the
second-order finite-difference hydrodynamics method described in
\zeus~\citep{Stone92a,Stone92b}.

We begin with the direct-Eulerian PPM implementation.  This is an
explicit, higher-order-accurate version of Godunov's method for ideal
gas dynamics with third order-accurate piecewise parabolic monotonic
interpolation and a nonlinear Riemann solver for shock capturing.  It
advances the hydrodynamic equations in the following steps:
%\begin{enumerate}
% \item 
(i) Construct monotonic parabolic interpolation of cell average data,
for each fluid quantity.
% \item 
(ii) Compute interface states by averaging the parabola over the
domain of dependence for each interface.
% \item 
(iii) Use interface data to solve the Riemann problem.
 %\item 
(iv) Difference the interface fluxes to update the cell average
quantities.
%\end{enumerate}

This PPM implementation does an excellent job of capturing strong
shocks in a few cells.  Multidimensional schemes are built up by
directional splitting and produce a method that is formally second
order-accurate in space and time and which explicitly conserves mass,
linear momentum, and energy \citep{Hawley84, Norman86}.  A variety of
Riemann solvers have been implemented.

As described in \citet{Bryan95}, we modify the method for use in
hypersonic flows when the thermal energy $e$ is extremely small
compared to the total energy $E$.  This is a problem because in the
total energy method, the temperature is computed by subtracting one
large number from another (i.e. the kinetic energy from the total
energy), a situation which can generate large numerical inaccuracies.
We address this situation by also solving the thermal energy equation
and using $e$ from this equation when we expect the error to be large.

%The advantage of the PPM method is that it conserves energy better and is higher-order accurate.  The disadvantage is that it is generally less robust than the ZEUS method.

\subsubsection{Godunov MUSCL (HD) with Dedner divergence cleaning (MHD)}
This solver was developed to attack problems in magnetic field
amplification during the formation of galaxies \citep{Wang:2009a} and
to understand the role of proto-stellar jets for the theory of star
formation \citep{Wang:2009b}. It combines the standard approach of
Godunov \citep{Godunov1959} for finite volume techniques with the
method of lines as described by \cite{leveque2002finite} and
\cite{toro-1997}. In addition, it implements the hyperbolic divergence
cleaning algorithm of \cite{2002JCoPh.175..645D}. It supports multiple
approximate Riemann solvers and non-ideal equations of
states. Consequently, these suite of solvers can be used for hydro and
magneto-hydrodynamic simulations. It is also this class of solvers as
well as a version of the PPM hydro solver which have been ported to
nVidia's CUDA framework allowing \enzo\ to take advantage of modern
graphics hardware \citep{Wang:2010}.

\subsubsection{MHD with Constrained Transport (MHD)}
This MHD method is second order in time and space, and preserves the
divergence constraint, $\nabla \cdot \vecB = 0$, to machine precision
through the Constrained Transport (CT) method.  CT, originally
described by \citet{Evans88}, updates the magnetic field with the curl
of an electric field, suitably formulated to preserve $\nabla \cdot
\vecB$.  We employ the CT methods described by \citet{Balsara99} and
\citet{Gardiner05}.  Further, we employ the second order hyperbolic
solver of \citet{Li08a} and the divergence free AMR scheme of
\citet{Balsara01}.

\subsubsection{Second order finite difference method (HD only)}

The last hydrodynamics method we briefly describe is the
finite-difference algorithm used in the \zeus\ code, as given in more
detail in \citet{Stone92a}.  For this reason, we call this the \zeus\
method, although the code is entirely independent of the \zeus\ code,
and only the hydrodynamical algorithm of \zeus\ is implemented in
\enzo\ -- the MHD and RHD schemes are not.

The \zeus\ method uses a staggered mesh such that the velocities are
face-centered, while the density and internal energy quantities are
cell-centered.  It splits the solution up into two steps, the
so-called source step, in which the momentum and energy values are
updated to reflect the pressure and gravity forces, as well as the
effect of an artificial viscosity required for stability.  The second
step (known as the transport step) accounts for the advection of
conserved quantities (mass, momentum and energy) across the grid.

\subsubsection{Gravity}

The current implementation of self-gravity in \enzo\ uses a Fast
Fourier Technique \citep{Hockney88} to solve Poisson's equation on the
coarsest (Level 0) grid on each time step.  The advantage of using
this method is that it is fast, accurate, and naturally allows both
periodic and isolated boundary conditions for the gravity, choices
which are very common in astrophysics and cosmology.  On subgrids, we
interpolate the boundary conditions from that grid's parent (either
the level 0 grid or some other subgrid).  The Poisson equation is then
solved on every timestep using a multigrid technique on one subgrid at
a time.  In \enzo, self-gravity is optional.  Aside from calculating
the gravitational potential from the baryon fields and particles
existing in the simulation, there are also a number of options for
static gravitational fields.

\subsubsection{N-body Dynamics}

Collisionless matter (e.g., dark matter, stars, etc.) is modeled with
particles that interact with the baryons only via gravity.  These
particles are advanced in a single time step using a drift-kick-drift
algorithm \citep{Hockney88} to provide second-order accuracy even in
the presence of changing timesteps.  Since the particles follow the
collapse of structure, they are not adaptively refined.  Nor are there
duplicate sets of particles for each level; instead, each particle is
associated with the highest refined level available at its position in
space and is moved as the hierarchy is rebuilt.  Thus, a particle has
the same timestep and feels the same gravitational force as a grid at
that refinement level.

Although the particles are fixed in mass once initialized, we can
create them with any initial set of masses and positions.  For
example, in many cosmological simulations, a static subgrid is
included from the beginning in order to improve the initial baryonic
mass resolution.  On this subgrid, we also use smaller particles to
improve the collisionless mass resolution.  One particle per initial
grid point seems to provide approximately equal sampling between the
dark matter and gas.

\subsubsection{Chemistry}
\label{sec.ov.chem}

\enzo\ includes the capability of following up to 12 chemical species
using a non-equilibrium solver.  The species can be turned on in sets,
with the simplest model including just H, H$^+$, He, He$^+$, He$^{++}$,
and e$^-$, and more complete models adding first species important for
gas-phase molecular hydrogen formation: H$^-$, H$_2$ and H$_2^+$, and
then HD formation: HD, D, D$^+$.  (We note that a reduced version
of the chemistry, used only with the flux-limited diffusion radiation
transport, includes only hydrogen species.)  The cooling and heating
due to these species is also included (see the next section).  The
solution of the rate equations is carried out using one Jacobi
iteration of an implicit Euler time discretization to ensure
stability; to ensure accuracy we sub-cycle the rate equations with a
shorter timestep such that the electron and neutral fractions do not
change by more than 10\%.

\subsubsection{Radiative Cooling and Heating}

Enzo may operate in a number of modes with regard to radiative cooling
and heating.  In the simplest mode, with the multi-species flag turned
off (i.e. set to zero), the cooling rate is computed from a simple
temperature-dependent cooling rate, taken from \citet{SW87}.  If
chemistry is turned on, then the code can include cooling from all
species of hydrogen and helium (including H$_2$) -- this primordial
cooling is treated in the same Jacobi iteration as the chemistry.
Finally, we have also recently added metal cooling based on a set of
multi-dimensional lookup tables computed with the \textsc{Cloudy} code
\citep{1998PASP..110..761F} as described in
\citet{2008MNRAS.385.1443S} and \citet{2011ApJ...731....6S}.  Finally,
we note that the cooling and heating is (almost always) treated in the
optically-thin limit, although the code can also follow radiative
transfer in a limited set of energy bins.

\subsubsection{Homogeneous radiation backgrounds}

The chemical networks and heating rates described in the previous
section can be affected by external radiation fields, and the code
includes a number of pre-set radiation backgrounds that are uniform in
space but can vary in time.  These are generally based on the
redshift-dependent rates given in \citet{1996ApJ...461...20H} and
\citet{2012ApJ...746..125H}, but can also include a uniform H$_2$
photo-dissociating background that is either constant in time or
varying as in \citet{WiseAbel05}.

\subsubsection{Radiation transport: ray tracing}

The code includes a photon-conserving radiative transfer algorithm
that is based on an adaptive ray-tracing method that utilizes the
HEALPix pixelization of a sphere \citep{AbelWandelt02}.  Photons are
integrated outwards from sources using an adaptive time-stepping
scheme that preserves accuracy in ionization fronts even in the
optically-thin limit.  This has been integrated with the chemistry and
cooling network to provide ionization and heating rates on a
cell-by-cell basis.  The method is described in more detail in our
main methodology section but is fully detailed and tested in
\citet{Wise11_Moray}.

\subsubsection{Radiation transport: Flux-limited diffusion}

A second option for radiative transfer is a moment-based method that
adds an additional field tracking the radiation energy density.
This field is evolved using the flux-limited diffusion method, which
transitions smoothly between streaming (optically thin) and opaque
limits and is coupled to the hydrogen ionization network.  The
resulting set of linear equations is solved using the parallel HYPRE
framework.  Full details for the \enzo\ implementation can be found in
\citet{ReynoldsHayesPaschosNorman2009}.

\subsubsection{Heat Conduction}

Heat conduction, both isotropic and anisotropic, can be included using
a sub-cycled, operator-split method.  The heat fluxes are computed
with simple second-order accurate finite differences and stability is
ensured by restricting the time step, and using flux-limiters where
appropriate.

\subsubsection{Star Formation and Feedback}

A family of simple heuristic methods are used to model the formation
of stars and their feedback of metals and energy into the gas.  These
methods are based on the work of \citet{CO1992}, and involve the
identification of plausible sites of star formation based on a set of
criteria (for example, dense gas with a short cooling time, which is
both collapsing and unstable).  The local star formation rate is
computed using a range of methods, such as a density-dependent method
based on the Schmidt-Kennicutt relation \citep{K89}.  The affected gas
is converted into a star particle over a few dynamical times, and
metals and thermal energy are injected into the region surrounding the
star particle.

\subsubsection{Timestep constraints}

All grids on a given level are advanced with the same timestep.  To
determine this timestep, we calculate, for each cell and for each
physical process (except for the chemistry step, which is sub-cycled),
the minimum $\Delta t$ allowed for stability.  Then the minimum of all
timesteps is taken and the level is advanced with this step.

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "ms"
%%% End: 
